<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Processing and Using SafeGraph Patterns Data • SafeGraphR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Processing and Using SafeGraph Patterns Data">
<meta property="og:description" content="SafeGraphR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SafeGraphR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SafeGraphR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Automatic_Traffic-over-Time_Processing.html">Automatic Traffic-over-Time Processing</a>
    </li>
    <li>
      <a href="../articles/distancing_vignette.html">Processing and Using SafeGraph Stay-at-Home Data</a>
    </li>
    <li>
      <a href="../articles/patterns_vignette.html">Processing and Using SafeGraph Patterns Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="patterns_vignette_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Processing and Using SafeGraph Patterns Data</h1>
            
      
      
      <div class="hidden name"><code>patterns_vignette.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SafeGraphR</span><span class="op">)</span></code></pre></div>
<p>This vignette will walk you through the process of reading in, processing, and displaying SafeGraph patterns data. This will look at the use of patterns data <em>generally</em>. For a more automated look at processing <code>visits_by_day</code> data for foot traffic over time, see the “Automatic Traffic-over-Time Processing” vignette.</p>
<p>This vignette will work with weekly data from the <em>weekly-patterns-delivery/weekly</em> SafeGraph Amazon Web Services bucket (see the <a href="https://catalog.safegraph.io">SafeGraph Catalog</a> for more information), which could also be downloaded using <code><a href="../reference/safegraph_aws.html">safegraph_aws()</a></code>. However, with only minor variation in the first section, the same processes could be applied to data downloaded from the SafeGraph shop, or to monthly patterns, or to <em>weekly-patterns/v2</em> data under the old format.</p>
<p>Note that throughout this vignette, we will be working with data manipulation using the <strong>data.table</strong> package. <strong>data.table</strong> is used throughout <strong>SafeGraphR</strong> (and on the backend) because it is very fast and can handle large data sets easily. However, once the data is read in and processed, it’s often no longer necessary to use <strong>data.table</strong> if you prefer something else. The code in this vignette could have easily used, for example, <strong>dplyr</strong> instead. If you are having trouble understanding the code chunks because you’re familiar with <strong>dplyr</strong> but not <strong>data.table</strong>, see <a href="https://atrebas.github.io/post/2019-03-03-datatable-dplyr/">this guide</a> that links the two.</p>
<hr>
<div id="reading-in-data" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-in-data" class="anchor"></a>Reading in Data</h1>
<p>We will be reading in data from the July 1, 2020 weekly patterns release (why only one week? To keep things small enough that the example data can be included in the package).</p>
<p>The <code><a href="../reference/read_patterns.html">read_patterns()</a></code> function can read in a single patterns file. But most of the time you will probably be using <code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code>, which reads multiple patterns files, processes them, and row-binds them together.</p>
<p>If you truly want the raw data, you are probably best off skipping <code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code> and instead just doing <code>list.files() %&gt;% purrr::map(data.table::fread) %&gt;% data.table::rbindlist()</code>. However, this would return an enormous result, and you probably just want a subset of the data, or some aggregated data.</p>
<p><code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code> can perform multiple different aggregations in a single go, aggregating each of them across multiple files.</p>
<p>So how can we build a <code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code> call? There are two main elements here: finding the files to read in, and then filling in the aggregation information in the <code>by, fun, na.rm, filter, expand_int, expand_cat,</code> and <code>expand_name</code> options.</p>
<p>For finding the files to fill in, you can use <code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code> itself, if what you want is <em>all</em> the files you have downloaded. Just specify the <code>dir</code> and it will load all the <code>.csv.gz</code> files in the subfolders of that directory. Or, you can be more choosy about it! Use <code><a href="../reference/patterns_lookup.html">patterns_lookup()</a></code> to generate a list of files (and, potentially, with a <code>key</code> and <code>secret</code>, download those files) that contain patterns information for a given set of dates (plus extra for moving-average purposes!). Then pass that filelist to the <code>filelist</code> option.</p>
<p>For aggregating, the <code>by, fun, na.rm, filter, expand_int, expand_cat,</code> and <code>expand_name</code> options are expanded further upon in <code><a href="../reference/read_patterns.html">read_patterns()</a></code>. Effectively, they determine the level to aggregate the data to (data will be aggregated to the <code>by</code>-and-expanded-JSON-column-index level), the function to use for aggregation (<code>fun</code>), whether to only pull a subset of the data (<code>filter</code>), and which of the JSON columns in the data to expand before aggregating (<code>expand_int</code> OR <code>expand_cat</code>, with <code>expand_name</code> giving the name of the index variable to be created).</p>
<p>So for example, if we want to get the number of <em>visits</em> by day by NAICS code, we would want to set <code>by = 'naics_code'</code>. The visits-by-day variable is <code>visits_by_day</code> and is stored in the format <code>[1,2,3,4,5,6,7]</code> which can be extracted internally by <code><a href="../reference/expand_integer_json.html">expand_integer_json()</a></code>, i.e. it’s a numeric JSON column (as opposed to a categorical JSON column like visits by CBG in the format <code>{category: number, category: number}</code> which can be extracted intenally by <code><a href="../reference/expand_cat_json.html">expand_cat_json()</a></code>). So we set <code>expand_int = 'visits_by_day'</code>. When we do <code>expand_int = 'visits_by_day'</code>, then <code>expand_name</code> will default to “day” so we don’t need to do anything there. We do want it to add up the visits by day across all the different POIs in that NAICS code, so <code>fun = sum</code> as default is fine. This gives us in total <code>by = 'naics_code', expand_int = 'visits_by_day'</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Not yet working code</span>
<span class="va">patterns_naics_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_patterns.html">read_many_patterns</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">'naics_code'</span>, expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span><span class="op">)</span></code></pre></div>
<p>Now instead let’s imagine we want the total number of <em>all</em> visits to any POI by county, but only in New York and New Jersey. Now we want to aggregate to the state/county level, so we want <code>by = c('state_fips', 'county_fips')</code> (don’t try just doing <code>'county_fips'</code> as the same county FIPS code is reused across states). Again we want <code>expand_int = 'visits_by_day'</code>. However, now that we are looking just at New York and New Jersey, we need to use <code>filter</code>, which we can do by specifying the filter as a string. So <code>filter = state_fips %in% c(34, 36)</code>, where 34 and 36 are the New Jersey and New York FIPS codes, respectively. So now we have <code>by = c('state_fips', 'county_fips'), expand_int = 'visits_by_day', filter = 'state_fips %in% c(34, 36)</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Not yet working code</span>
<span class="va">patterns_NY_NJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_patterns.html">read_many_patterns</a></span><span class="op">(</span>by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>, <span class="st">'county_fips'</span><span class="op">)</span>, 
                                    expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span>, 
                                    filter <span class="op">=</span> <span class="st">'state_fips %in% c(34, 36)'</span><span class="op">)</span></code></pre></div>
<p>Those are the relevant aggregation options to follow. And, since we want both of them, we can get them both in one call (rather than having to read in the data separately for each, which is slow). We just toss each of these sets of options in a <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>, adding the required option <code>name</code> to tell us which aggregation we’re doing, and then putting both of those lists in a bigger <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> for <code>multi</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Not yet working code</span>
<span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_patterns.html">read_many_patterns</a></span><span class="op">(</span>multi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'patterns_naics'</span>,
       by <span class="op">=</span> <span class="st">'naics_code'</span>, 
       expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'NY_NJ'</span>,
       by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>, <span class="st">'county_fips'</span><span class="op">)</span>, 
       expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span>, 
       filter <span class="op">=</span> <span class="st">'state_fips %in% c(34, 36)'</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>What else do we need?</p>
<p>First, of course, we need to tell it where the patterns files are. We can specify <code>dir</code> (or it will just go to the working directory). Or if we want to do our own <code><a href="https://rdrr.io/r/base/list.files.html">list.files()</a></code> command and pick a subset, we can give it to <code>filelist</code>. Since we are working with new-format data that sits inside nested folders, we want to be sure to specify <code>recursive = TRUE</code> so as to look in those folders.</p>
<p>Second, if we want to aggregate (or filter) by NAICS code, which we do, we need to know the NAICS code of each POI. We can do that by processing the most recent monthly SafeGraph Core file using <code>read_core</code>. <code>read_core</code> will use the most recent Core file in the <code>core_poi/</code> directory of the working directory - it will download the most recent one too if you give it an AWS <code>key</code> and <code>secret</code>! Then we can pass the resulting file to the <code>naics_link</code> option.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">poi_link</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_core.html">read_core</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'placekey'</span>,<span class="st">'naics_code'</span><span class="op">)</span><span class="op">)</span>
<span class="co"># I probably at this point would save poi_link to disk - that took a while!</span></code></pre></div>
<p>Next, if we want to use the state and county FIPS codes, we want to make sure that <code>gen_fips = TRUE</code>, which it is by default, so we’re good there. This uses <code><a href="../reference/fips_from_cbg.html">fips_from_cbg()</a></code> internally.</p>
<p>Fourth, patterns files don’t tell you what the first date in them is. <code><a href="../reference/read_many_patterns.html">read_many_patterns()</a></code> will try to guess that date by the filepath. But if you want to be sure, you can set <code>start_date</code> for each of the files being read in. You can more easily find the starting dates using the <code><a href="../reference/find_date.html">find_date()</a></code> function (which is what <code><a href="../reference/read_patterns.html">read_patterns()</a></code> uses internally. Don’t forget to subtract <code><a href="http://lubridate.tidyverse.org/reference/period.html">lubridate::days(9)</a></code> to get the starting date for non-backfill data!</p>
<p>Finally, and very important, if we are doing any sort of aggregation we probably want to specify <code>select</code>, a character vector of variables to be read in. If we don’t, then reading in the data will take <em>way</em> longer. Also, if some of those variables aren’t amenable to being aggregated with <code>fun</code>, you could get an error. We are planning to use the <code>visits_by_day</code> variable so we need that. We’ll also use <code>poi_cbg</code> (to be sent to <code><a href="../reference/fips_from_cbg.html">fips_from_cbg()</a></code> to get <code>state_fips</code> and <code>county_fips</code>), but that’s in by default whenever <code>gen_fips = TRUE</code>. We also need <code>naics_code</code>, but that isn’t read in from the file; rather it comes from the <code>poi_link</code> data we made. So we specify <code>select = 'visits_by_day'</code>.</p>
<p>See the <a href="https://docs.safegraph.com/docs">SafeGraph docs</a> for full documentation of all the available variables.</p>
<p>Note that <code>select</code> applies to the file as it’s read in before any aggregation, so it goes in <code>read_many_patterns</code> directly, not inside of <code>multi</code>.</p>
<p>In total, we have:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Assume our working directory is the the /patterns/ folder</span>
<span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_patterns.html">read_many_patterns</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">TRUE</span>,
                               naics_link <span class="op">=</span> <span class="va">poi_link</span>,
                               select <span class="op">=</span> <span class="st">'visits_by_day'</span>,
                               multi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'patterns_naics'</span>,
                                      by <span class="op">=</span> <span class="st">'naics_code'</span>, 
                                      expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span><span class="op">)</span>,
                                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'NY_NJ'</span>,
                                      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>, <span class="st">'county_fips'</span><span class="op">)</span>, 
                                      expand_int <span class="op">=</span> <span class="st">'visits_by_day'</span>, 
                                      filter <span class="op">=</span> <span class="st">'state_fips %in% c(34, 36)'</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Internally, this calls <code><a href="../reference/read_patterns.html">read_patterns()</a></code> many times, followed by <code><a href="../reference/rbind_by_list_pos.html">rbind_by_list_pos()</a></code>. Then it re-aggregates across the multiple files it just read in (unless you set ).</p>
<p>The result will be <code>patterns</code>, a list, where <code>patterns[[1]]</code> (or <code>patterns[['patterns_naics']]</code>) contains the NAICS aggregation, and <code>patterns[[2]]</code> (or <code>patterns[['NY_NJ']]</code>) contains the New York/New Jersey aggregation. Let’s save those as their own objects (which will then be a part of the package so we can use real data in this vignette!).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This data is one observation per NAICS code per day</span>
<span class="va">pat_naics</span> <span class="op">&lt;-</span> <span class="va">patterns</span><span class="op">[[</span><span class="st">'patterns_naics'</span><span class="op">]</span><span class="op">]</span>
<span class="co"># This data is one observation per NY/NJ county per day</span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="va">patterns</span><span class="op">[[</span><span class="st">'NY_NJ'</span><span class="op">]</span><span class="op">]</span>
<span class="co"># At this point I'd save both of these to disk, that took a whole five minutes!</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">patterns</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Now to load in for real!</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">pat_naics</span><span class="op">)</span>
<span class="va">pat_naics</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       naics_code state_fips county_fips visits_by_day day start_date       date</span>
<span class="co">#&gt;    1:         NA     105563      368142          9441   1 2020-06-22 2020-06-22</span>
<span class="co">#&gt;    2:         NA     105563      368142          9447   2 2020-06-22 2020-06-23</span>
<span class="co">#&gt;    3:         NA     105563      368142         10063   3 2020-06-22 2020-06-24</span>
<span class="co">#&gt;    4:         NA     105563      368142         10096   4 2020-06-22 2020-06-25</span>
<span class="co">#&gt;    5:         NA     105563      368142         10717   5 2020-06-22 2020-06-26</span>
<span class="co">#&gt;   ---                                                                          </span>
<span class="co">#&gt; 9243:     928120        933        2663           147   3 2020-06-22 2020-06-24</span>
<span class="co">#&gt; 9244:     928120        933        2663           155   4 2020-06-22 2020-06-25</span>
<span class="co">#&gt; 9245:     928120        933        2663           152   5 2020-06-22 2020-06-26</span>
<span class="co">#&gt; 9246:     928120        933        2663            60   6 2020-06-22 2020-06-27</span>
<span class="co">#&gt; 9247:     928120        933        2663            40   7 2020-06-22 2020-06-28</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span><span class="op">)</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       state_fips county_fips naics_code visits_by_day day start_date       date</span>
<span class="co">#&gt;    1:         34           1         NA          5862   1 2020-06-22 2020-06-22</span>
<span class="co">#&gt;    2:         34           1         NA          5754   2 2020-06-22 2020-06-23</span>
<span class="co">#&gt;    3:         34           1         NA          5769   3 2020-06-22 2020-06-24</span>
<span class="co">#&gt;    4:         34           1         NA          5887   4 2020-06-22 2020-06-25</span>
<span class="co">#&gt;    5:         34           1         NA          6778   5 2020-06-22 2020-06-26</span>
<span class="co">#&gt;   ---                                                                          </span>
<span class="co">#&gt; 2320:         36         123   40485879           253   3 2020-06-22 2020-06-24</span>
<span class="co">#&gt; 2321:         36         123   40485879           217   4 2020-06-22 2020-06-25</span>
<span class="co">#&gt; 2322:         36         123   40485879           294   5 2020-06-22 2020-06-26</span>
<span class="co">#&gt; 2323:         36         123   40485879           440   6 2020-06-22 2020-06-27</span>
<span class="co">#&gt; 2324:         36         123   40485879           245   7 2020-06-22 2020-06-28</span></code></pre></div>
<p>Notice in looking at <code>pat_naics</code> that the missing-NAICS code POIs have been included. Also notice that <code>state_fips</code> and <code>county_fips</code> are nonsense. We loaded them in (for <code>pat_NY_NJ</code>) but then didn’t use them in aggregation! So it summed them up and they’re nonsense now. Same issue with <code>naics_code</code> in <code>pat_NY_NJ</code>. We can drop them.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pat_naics</span><span class="op">[</span>,<span class="va">state_fips</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">pat_naics</span><span class="op">[</span>,<span class="va">county_fips</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span>,<span class="va">naics_code</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></code></pre></div>
<p>We will also need the normalization data to properly work with what we have. Normalization data is just in regular ol’ CSV files, so we can read everything in with <code><a href="../reference/read_many_csvs.html">read_many_csvs()</a></code>. Since normalization files have <code>year</code>, <code>month</code>, and <code>day</code> columns, we can also set <code>makedate = TRUE</code> to get a <code>date</code> variable in there. If we only want to normalize at the national level, pick the <code>ALL_STATES</code> rows.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_csvs.html">read_many_csvs</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">"../normalization_stats/"</span>,
                       recursive <span class="op">=</span> <span class="cn">TRUE</span>,
                       makedate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="va">region</span> <span class="op">==</span> <span class="st">'ALL_STATES'</span><span class="op">]</span>
<span class="va">norm</span><span class="op">[</span>, <span class="va">region</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">norm</span><span class="op">)</span>
<span class="va">norm</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;    total_visits total_devices_seen total_home_visits total_home_visitors</span>
<span class="co">#&gt; 1:     50656915           17312070          23890767            14335375</span>
<span class="co">#&gt; 2:     50805493           16870682          23389482            14021137</span>
<span class="co">#&gt; 3:     52223098           17103600          23758844            14153853</span>
<span class="co">#&gt; 4:     52544946           17014972          23460878            13980621</span>
<span class="co">#&gt; 5:     54186679           16964900          23425016            13993356</span>
<span class="co">#&gt; 6:     49766561           16304498          22301353            13344340</span>
<span class="co">#&gt; 7:     45347171           16341487          23068199            13912816</span>
<span class="co">#&gt;          date</span>
<span class="co">#&gt; 1: 2020-06-22</span>
<span class="co">#&gt; 2: 2020-06-23</span>
<span class="co">#&gt; 3: 2020-06-24</span>
<span class="co">#&gt; 4: 2020-06-25</span>
<span class="co">#&gt; 5: 2020-06-26</span>
<span class="co">#&gt; 6: 2020-06-27</span>
<span class="co">#&gt; 7: 2020-06-28</span></code></pre></div>
<p>Finally, if we want to do <code><a href="../reference/sample_size_adjust.html">sample_size_adjust()</a></code>, we will need the number of devices by region from the home panel summary files. We can also read this with <code><a href="../reference/read_many_csvs.html">read_many_csvs()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make sure that census_block_group is read as a character</span>
<span class="co"># note colClasses is a data.table::fread() argument</span>
<span class="va">panel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_many_csvs.html">read_many_csvs</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">'../home_panel_summary'</span>, 
                        colClasses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>census_block_group <span class="op">=</span> <span class="st">'character'</span><span class="op">)</span><span class="op">)</span>
<span class="co"># We only need the start date, census block group, and number of devices</span>
<span class="va">panel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">panel</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'date_range_start'</span>, <span class="st">'census_block_group'</span>, <span class="st">'number_devices_residing'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># We will be needing this only at the county level</span>
<span class="va">panel</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>,<span class="st">'county_fips'</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fips_from_cbg.html">fips_from_cbg</a></span><span class="op">(</span><span class="va">census_block_group</span><span class="op">)</span><span class="op">]</span>
<span class="va">panel</span> <span class="op">&lt;-</span> <span class="va">panel</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>number_devices_residing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">number_devices_residing</span><span class="op">)</span>,
                  date_range_start <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">date_range_start</span><span class="op">)</span><span class="op">)</span>,
               by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>,<span class="st">'county_fips'</span><span class="op">)</span><span class="op">]</span>

<span class="co"># We don't need the timestamp in the date range but we DO need it to be named 'start_date'</span>
<span class="va">panel</span><span class="op">[</span>,<span class="va">start_date</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date_range_start</span><span class="op">)</span><span class="op">]</span>
<span class="va">panel</span><span class="op">[</span>,<span class="va">date_range_start</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">panel</span><span class="op">)</span>
<span class="va">panel</span><span class="op">[</span><span class="op">]</span>
<span class="co">#&gt;       state_fips county_fips number_devices_residing start_date</span>
<span class="co">#&gt;    1:          2         170                    4565 2020-06-22</span>
<span class="co">#&gt;    2:          2         195                      73 2020-06-22</span>
<span class="co">#&gt;    3:          2         158                      90 2020-06-22</span>
<span class="co">#&gt;    4:          2          90                    3562 2020-06-22</span>
<span class="co">#&gt;    5:          2          50                     175 2020-06-22</span>
<span class="co">#&gt;   ---                                                          </span>
<span class="co">#&gt; 3224:         56          15                     626 2020-06-22</span>
<span class="co">#&gt; 3225:         56          11                     367 2020-06-22</span>
<span class="co">#&gt; 3226:         56          35                     431 2020-06-22</span>
<span class="co">#&gt; 3227:         56          17                     236 2020-06-22</span>
<span class="co">#&gt; 3228:         56          19                     483 2020-06-22</span></code></pre></div>
<hr>
</div>
<div id="processing-data" class="section level1">
<h1 class="hasAnchor">
<a href="#processing-data" class="anchor"></a>Processing Data</h1>
<p>We have a few goals at this point:</p>
<ol style="list-style-type: decimal">
<li>Do any further aggregation or adjustments we like, and normalize</li>
<li>Smooth out weekend effects</li>
<li>Scale visit data relative to a date (absolute values don’t work that well)</li>
<li>Make the data presentable!</li>
</ol>
<div id="do-any-further-aggregation-or-adjustments-and-normalize" class="section level2">
<h2 class="hasAnchor">
<a href="#do-any-further-aggregation-or-adjustments-and-normalize" class="anchor"></a>1. Do any further aggregation or adjustments, and normalize</h2>
<p>The aggregation we want to do at this point depends on where we want the data to go. Let’s work on <code>pat_NY_NJ</code>. If we want to use state-level data to inform individual county estimates, we should consider using <code>hb_shrink</code> (and an example of that will be in the social distancing vignette). But if we want to use county-level estimates to aggregate up to the state level, we might want to use <code><a href="../reference/sample_size_adjust.html">sample_size_adjust()</a></code> to account for differences in sampling rates across counties.</p>
<p>You may also want to do more adjustments for changes over time in the sample size, as described in Section 2 of the <a href="https://colab.research.google.com/drive/16BELpcum4TKoH-5wg8Xym_CGgIGgpu1I?usp=sharing">Normalization Best Practices</a> guide. But this is not done here (except in the normalization step).</p>
<p>In general, <code><a href="../reference/sample_size_adjust.html">sample_size_adjust()</a></code> compares the number of devices in each county (or census block group) to the population in that area, and adjusts the total counts as though every region were sampled at the same rate.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First merge in panel, which has the number_devices_residing we need to know how big the SafeGraph sample is in that area</span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>, <span class="va">panel</span><span class="op">)</span>

<span class="co"># we are going FROM county TO state</span>
<span class="co"># the use of number_devices_residing is default</span>
<span class="co"># data(county_pop) will be used by default for the adjustment</span>
<span class="va">adjust_factor</span> <span class="op">&lt;-</span> <span class="va">pat_NY_NJ</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/sample_size_adjust.html">sample_size_adjust</a></span><span class="op">(</span>from_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>,<span class="st">'county_fips'</span><span class="op">)</span>,
                     from_level <span class="op">=</span> <span class="st">'county'</span>,
                     to_level <span class="op">=</span> <span class="st">'state'</span><span class="op">)</span>
<span class="co"># There are a few counties we don't have county population data for</span>
<span class="co"># For these let's assume we don't need to adjust</span>
<span class="va">adjust_factor</span><span class="op">[</span>, <span class="va">adjust_factor</span> <span class="op">:=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">fifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">adjust_factor</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">adjust_factor</span><span class="op">)</span><span class="op">]</span>

<span class="co"># And adjust visits </span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>, <span class="va">adjust_factor</span><span class="op">)</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span>, <span class="va">visits_by_day_adj</span> <span class="op">:=</span> <span class="va">visits_by_day</span><span class="op">*</span><span class="va">adjust_factor</span><span class="op">]</span>

<span class="co"># And aggregate to the state level</span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="va">pat_NY_NJ</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>visits_by_day_adj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">visits_by_day_adj</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>, <span class="st">'date'</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>Now for NAICS, we don’t need to do this sample size adjustment. However, <strong>as previously mentioned</strong>, this used new data, so we have one row per NAICS code per day <strong>per original file</strong>, and since the patterns data was broken up into four files, we have four rows where we want one, and need to aggregate again.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pat_naics</span> <span class="op">&lt;-</span> <span class="va">pat_naics</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>visits_by_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">visits_by_day</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'naics_code'</span>, <span class="st">'date'</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>Next up we normalize by the size of the SafeGraph data set on the day, which came from the normalization stats.</p>
<p>This is as simple as merging in our <code>norm</code> data we made, and dividing by <code>total_devices_seen</code>. We do this for both <code>pat_NY_NJ</code> and <code>pat_naics</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>, <span class="va">norm</span>, by <span class="op">=</span> <span class="st">'date'</span><span class="op">)</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span>, <span class="va">norm_visits</span> <span class="op">:=</span> <span class="va">visits_by_day_adj</span><span class="op">/</span><span class="va">total_devices_seen</span><span class="op">]</span>

<span class="va">pat_naics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_naics</span>, <span class="va">norm</span>, by <span class="op">=</span> <span class="st">'date'</span><span class="op">)</span>
<span class="va">pat_naics</span><span class="op">[</span>, <span class="va">norm_visits</span> <span class="op">:=</span> <span class="va">visits_by_day</span><span class="op">/</span><span class="va">total_devices_seen</span><span class="op">]</span></code></pre></div>
</div>
<div id="smooth-out-weekend-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#smooth-out-weekend-effects" class="anchor"></a>2. Smooth out weekend effects</h2>
<p>We can use the <code><a href="../reference/ma.html">ma()</a></code> function, which is a (by default) seven-day moving average to smooth out day-of-week (especially weekend) effects.</p>
<p>Just make sure we’re ordered by date first, and perform the calculation by group.</p>
<p>Note that I am not actually running this code in the vignette since the example data is only seven days long.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Not actually run because example data is too short:</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>, <span class="va">state_fips</span>, <span class="va">date</span><span class="op">)</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span>, <span class="va">norm_visits</span> <span class="op">:=</span> <span class="fu"><a href="../reference/ma.html">ma</a></span><span class="op">(</span><span class="va">norm_visits</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'state_fips'</span><span class="op">]</span>

<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">pat_naics</span>, <span class="va">naics_code</span>, <span class="va">date</span><span class="op">)</span>
<span class="va">pat_naics</span><span class="op">[</span>, <span class="va">norm_visits</span> <span class="op">:=</span> <span class="fu"><a href="../reference/ma.html">ma</a></span><span class="op">(</span><span class="va">norm_visits</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'naics_code'</span><span class="op">]</span></code></pre></div>
</div>
<div id="scale-visit-data-relative-to-a-date" class="section level2">
<h2 class="hasAnchor">
<a href="#scale-visit-data-relative-to-a-date" class="anchor"></a>3. Scale visit data relative to a date</h2>
<p>SafeGraph does a much better job showing <em>growth</em> or <em>change</em> in visits, rather than the absolute number of visits, since it’s hard to pin down exactly how much of the population we’re looking at.</p>
<p>So for most analyses we want to scale visits relative to a given date. We can do this with <code><a href="../reference/scale_to_date.html">scale_to_date()</a></code> (with multiple years of data we could do <code><a href="../reference/scale_yoy.html">scale_yoy()</a></code>). This process could be automated for <code>visits_by_day</code> data with the <code><a href="../reference/processing_template.html">processing_template()</a></code> function.</p>
<p>Let’s just scale to the first date in the data, June 22, 2020.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Careful with by! The data really should be uniquely identified by the combination of date_var and by.</span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="va">pat_NY_NJ</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/scale_to_date.html">scale_to_date</a></span><span class="op">(</span>adj_vars <span class="op">=</span> <span class="st">'norm_visits'</span>,
                date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">'2020-06-22'</span><span class="op">)</span>,
                by <span class="op">=</span> <span class="st">'state_fips'</span><span class="op">)</span>

<span class="va">pat_naics</span> <span class="op">&lt;-</span> <span class="va">pat_naics</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/scale_to_date.html">scale_to_date</a></span><span class="op">(</span>adj_vars <span class="op">=</span> <span class="st">'norm_visits'</span>,
                date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">'2020-06-22'</span><span class="op">)</span>,
                by <span class="op">=</span> <span class="st">'naics_code'</span><span class="op">)</span></code></pre></div>
</div>
<div id="make-the-data-presentable" class="section level2">
<h2 class="hasAnchor">
<a href="#make-the-data-presentable" class="anchor"></a>4. Make the data presentable!</h2>
<p>All we have to do at this point is bring in the appropriate labels, and graph things (or do whatever we’d like to do).</p>
<p>The <code>fips_to_names</code> data set has state and county names. We’ll be using it to put “New York” and “New Jersey” in the appropriate places (not that that’s too tricky to do by hand in this reduced example).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"fips_to_names"</span><span class="op">)</span>
<span class="co"># This comes with both county and state. We only want state for this application since we already aggregated away the counties</span>
<span class="va">fips_to_names</span> <span class="op">&lt;-</span> <span class="va">fips_to_names</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>, <span class="st">'statename'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># and merge in</span>
<span class="va">pat_NY_NJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>, <span class="va">fips_to_names</span><span class="op">)</span>
<span class="va">pat_NY_NJ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'state_fips'</span>,<span class="st">'statename'</span>,<span class="st">'date'</span>,<span class="st">'norm_visits'</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;     state_fips  statename       date norm_visits</span>
<span class="co">#&gt;  1:         34 New Jersey 2020-06-22  0.00000000</span>
<span class="co">#&gt;  2:         34 New Jersey 2020-06-23  0.03211382</span>
<span class="co">#&gt;  3:         34 New Jersey 2020-06-24  0.05995530</span>
<span class="co">#&gt;  4:         34 New Jersey 2020-06-25  0.07611231</span>
<span class="co">#&gt;  5:         34 New Jersey 2020-06-26  0.14633842</span>
<span class="co">#&gt;  6:         34 New Jersey 2020-06-27  0.04615868</span>
<span class="co">#&gt;  7:         34 New Jersey 2020-06-28 -0.12373093</span>
<span class="co">#&gt;  8:         36   New York 2020-06-22  0.00000000</span>
<span class="co">#&gt;  9:         36   New York 2020-06-23  0.05549741</span>
<span class="co">#&gt; 10:         36   New York 2020-06-24  0.07369239</span>
<span class="co">#&gt; 11:         36   New York 2020-06-25  0.09724966</span>
<span class="co">#&gt; 12:         36   New York 2020-06-26  0.14681163</span>
<span class="co">#&gt; 13:         36   New York 2020-06-27 -0.03903597</span>
<span class="co">#&gt; 14:         36   New York 2020-06-28 -0.13794200</span></code></pre></div>
<p>The <code>naics_codes</code> data set links NAICS codes to their titles. These can sometimes still be a little longer than we need, but at least now we’ll know what they mean! If we had aggregated to the four-digit or two-digit NAICS code level using <code><a href="https://rdrr.io/r/base/Round.html">floor(naics_code/100)</a></code> or <code><a href="https://rdrr.io/r/base/Round.html">floor(naics_code/10000)</a></code>, we could instead label them using the <code>naics_4</code> or <code>naics_2</code> data sets.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"naics_codes"</span><span class="op">)</span>

<span class="co"># Without specifying to keep all rows in X, this will omit the missing NAICS codes</span>
<span class="va">pat_naics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">pat_naics</span>, <span class="va">naics_codes</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">pat_naics</span>, <span class="va">naics_code</span>, <span class="va">naics_title</span>, <span class="va">date</span><span class="op">)</span>
<span class="va">pat_naics</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'naics_code'</span>,<span class="st">'naics_title'</span>,<span class="st">'date'</span>,<span class="st">'norm_visits'</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;       naics_code                 naics_title       date norm_visits</span>
<span class="co">#&gt;    1:     111421 Nursery and Tree Production 2020-06-22  0.00000000</span>
<span class="co">#&gt;    2:     111421 Nursery and Tree Production 2020-06-23  0.06814242</span>
<span class="co">#&gt;    3:     111421 Nursery and Tree Production 2020-06-24  0.16861782</span>
<span class="co">#&gt;    4:     111421 Nursery and Tree Production 2020-06-25  0.38282196</span>
<span class="co">#&gt;    5:     111421 Nursery and Tree Production 2020-06-26  0.33124169</span>
<span class="co">#&gt;   ---                                                              </span>
<span class="co">#&gt; 2383:     928120       International Affairs 2020-06-24  0.05801610</span>
<span class="co">#&gt; 2384:     928120       International Affairs 2020-06-25  0.07153863</span>
<span class="co">#&gt; 2385:     928120       International Affairs 2020-06-26  0.02247280</span>
<span class="co">#&gt; 2386:     928120       International Affairs 2020-06-27 -0.41057716</span>
<span class="co">#&gt; 2387:     928120       International Affairs 2020-06-28 -0.61628256</span></code></pre></div>
<p>Now we can finally make some pretty graphs (why so much movement over the space of only one week? Becuase we skipped the seven-day-moving-average step!). This makes a graph by hand using <strong>ggplot2</strong> directly, but you can often also make a nice-looking graph automatically with <code><a href="../reference/graph_template.html">graph_template()</a></code>, which also uses <strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span>,
                <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">norm_visits</span>, color <span class="op">=</span> <span class="va">statename</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                 panel.grid.minor.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
                 text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>, family <span class="op">=</span> <span class="st">'serif'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Date'</span>,
                y <span class="op">=</span> <span class="st">'Change Since June 22'</span>,
                title <span class="op">=</span> <span class="st">'SafeGraph: Change in Visits Since June 22, 2020'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">directlabels</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/directlabels/man/geom_dl.html">geom_dl</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span> <span class="op">+</span> <span class="fl">.1</span>, label <span class="op">=</span> <span class="va">statename</span><span class="op">)</span>, 
                        method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'last.bumpup'</span>, cex <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">pat_NY_NJ</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">)</span></code></pre></div>
<p><img src="patterns_vignette_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rests</span> <span class="op">&lt;-</span> <span class="va">pat_naics</span> <span class="op">%&gt;%</span>
  <span class="co"># Restaurant codes</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">naics_code</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">==</span> <span class="fl">722</span><span class="op">)</span>

<span class="co"># The NAICS titles can be too long for graphs, so we won't use naics_codes</span>
<span class="va">short_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>naics_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">rests</span><span class="op">$</span><span class="va">naics_title</span><span class="op">)</span>,
                          naics_short <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Caterer'</span>,
                                          <span class="st">'Bar'</span>,
                                          <span class="st">'Restaurant'</span>,
                                          <span class="st">'Fast Food'</span>,
                                          <span class="st">'Cafeteria'</span>,
                                          <span class="st">'Cafe'</span><span class="op">)</span><span class="op">)</span>

<span class="va">rests</span> <span class="op">&lt;-</span> <span class="va">rests</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">pat_naics</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">short_names</span>, by <span class="op">=</span> <span class="st">'naics_title'</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">setorder</a></span><span class="op">(</span><span class="va">rests</span>, <span class="op">-</span><span class="va">norm_visits</span><span class="op">)</span>
<span class="va">rests</span><span class="op">$</span><span class="va">naics_short</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">rests</span><span class="op">$</span><span class="va">naics_short</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">rests</span><span class="op">$</span><span class="va">naics_short</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">rests</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">naics_short</span>, y <span class="op">=</span> <span class="va">norm_visits</span>, fill <span class="op">=</span> <span class="va">norm_visits</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">naics_short</span>, <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">norm_visits</span>, accuracy <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span>, 
                                  y <span class="op">=</span> <span class="va">norm_visits</span> <span class="op">+</span> <span class="fl">.01</span> <span class="op">-</span> <span class="fl">.02</span><span class="op">*</span><span class="op">(</span><span class="va">norm_visits</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,
                 plot.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,
                 panel.grid <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#CC0000'</span>,<span class="st">'black'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">''</span>, y <span class="op">=</span> <span class="st">'Change from June 22 to June 29'</span>, title <span class="op">=</span> <span class="st">'SafeGraph: One-Week Change in Visits for Prepared Food Locations'</span><span class="op">)</span>
<span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span>
<span class="co">#&gt; "none")` instead.</span></code></pre></div>
<p><img src="patterns_vignette_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nick Huntington-Klein.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
